---
title: "Cleaning the cooperatives database"
output:
    html_notebook:
      toc: yes
      toc_depth: 4
      toc_float:
        collapsed: no
---

## Load packages

```{r}
suppressPackageStartupMessages({
  library(magrittr)
  library(tidyverse)
})
```



## Read in the data

First we will read in all the data from the original csv file, where no changes have been made. We read it in setting `na.strings = 999`, because that is what was used in the creation of the database to report a missing value. We want to convert those to `NA`'s. We will also use `stringAsFactors = F` to make sure that string variables are interpreted as text, not factors. Finally, we include `strip.white = T` to lead any white spaces before or after any words.

```{r}
# Read the data
cooperatives_db <- read.csv("master cooperative database for analysis.csv",
                            na.strings = 999,
                            stringsAsFactors = F,
                            strip.white = T)
# Get a preview
head(cooperatives_db)
```

**You can see that the database has `r dim(cooperatives_db)[1]` rows and `r dim(cooperatives_db)[2]` columns.**

## Standardize column names

We can see that the column names are not standard. Some of them have capital letters, some of them dont. Some include repeated characters, such as `__` instead of just `_`. We want to make sure we fix all these.

First, lets identify all problems:

```{r}
colnames(cooperatives_db)
```

By looking at the column names, there are a few things that we might want to do:

- Convert everything to `snake_case`, where nothing is capitalized and words are separated by a `_`.
- Some values, like column 43 (`Subsidy_as_a___of_landed_value`) have repeated characters, and we want to see `subsidy_as_a_of_landed_values`
- Some values have trailing `_`, like `GDP_from_fishing__US_`, in column 40. We want this to be `gdp_from_fishing_us`
- Government is abbreviated as `gov_t`, like in column 119 (`Gov_t_Ambivalent`). We want this as `gov_ambivalent`
- We see many cases where `cooperative` or `comanagement` are separated by `_` (column 109; `Vessels__co_op_`), and we want `vessels_coop`

We can fix all these with the use of regular expressions and string substitutions:

```{r}
columns <- colnames(cooperatives_db) %>%
  tolower() %>%
  gsub(pattern = "(_)\\1+", replacement = "_") %>% 
  gsub(pattern = "_+$", replacement = "") %>% 
  gsub(pattern = "gov_t", replacement = "gov") %>% 
  gsub(pattern = "co_", replacement = "co") %>% 
  gsub(pattern = "subsidy_as_a_of_landed_value", replacement = "subsidy_as_a_percent_of_landed_value") %>% 
  gsub(pattern = "a_of_gdp_from_fishing", replacement = "percent_of_gdp_from_fishing")

columns
```

Once we like how these look, we just re-name the columns in `cooperatives_db`

```{r}
colnames(cooperatives_db) <- columns

head(cooperatives_db)
```

## Standardize values

Now that the columns look beter, we can go ahead and clean the data itself. First, it would help at identifying all the unique values for each column. In this tree-like viewer, you can click on each of the column names and see a list of all the unique values within it. For example, `entered_by`, which contains information on who entered the data has the unique values `r unique(cooperatives_db$entered_by)`.

```{r}
sort_unique <- function(x){sort(unique(x))}
 
lapply(cooperatives_db, sort_unique) %>% 
  listviewer::jsonedit()
```

By reviewing each of the above, we can identify the following things we might want to fix:

### General fixes

- ~~Make everything sentence case (*i.e.* only first letter of first word capitalized)~~
- Convert values of `(0, 1)` to `(FALSE, TRUE)`

### Column-level fixes

- `entered_by`
    - ~~Contains missing values labeled as `""`, but we want those to be `NA`'s~~
- `umbrella_organization`:
    - ~~Has values of 0, `null` (which are `NA`), 1, and 2.~~
    - ~~These is supposed to be a boolean (*i.e.* `TRUE` / `FALSE`).~~
    - ~~We will set values `umbrella_organization_i > 1` as `TRUE` and `umbrella_organization < 1 as FALSE`~~
- `target_species`:
    - ~~Standardize everything to remove capitalized letters~~
    - Conver all names into english (?)
    - ~~Records 43 (`Callo de hacha (Pen shell)`) and 44 (`Callo de hacha / Pen shell`) are the same species~~
    - There is one missing value. We might be able to fix it based on the scientific name (`complete_name`)
- `complete_name`:
    - Must make sure the names are still valid (?)
    - Missing names (?)
    - ~~Change `Genus sp.` and `Genus spp.` to `Genus spp`~~
    - ~~Delete duplicated white spaces (`Farfantepenaeus  californiensis` to `Farfantepenaeus californiensis`)~~
    - ~~Caribean spiny lobster is lised as `Panulirus argus` and `Panuliris argus`~~
- `fb_migration`:
    - Has values of `r sort(unique(cooperatives_db$fb_migration))`
    - Make sure these are standardized
- `fish_type`:
    - ~~has repeated cases (`Finfish - pelagic` and `Finfish - Pelagic`)~~
- `habitat`:
    - ~~repeated cases (`deep water` and `Deep water`) and other similar captialization issues~~
- `fished_habitat`:
    - ~~repeated cases (`deep water` and `Deep water`) and other similar captialization issues~~
- `species_growth`:
    - ~~Has values of `r sort(unique(cooperatives_db$species_growth))`~~
    - ~~Perhaps `Slow` and `Low` mean the same thing? Review metadata~~
- `adult_movement`
    - ~~Some values are separated by double dashes `--`~~
- `catch_share_types`
    - ~fix values of `Co-op` to `coop`~
    - compose a `catch_share_types2` column based on the columns right next to this one
- `species_value` and `unit_of_value`
    - will be fixed by Andrew
- `gear_type`
    - ~~misspelled values~~
- `landings_coop` and `landings_units`
    - fixed by Andrew
- `use_of_catch`
    - ~~Long record must be shortened (`1.local market (mostly wholesale) 2. subsistence (www.indiana.edu/~voconf/papers/thomson_voconf.pdf)", "local market/subsistance`)~~
    - ~~Replace `;` wih `/`~~

Most of these problems can be fixed easily by making some small functions:

### Function to transform ONLY CHARACCTER VECTORS to lower

```{r}
ToLower <- function(x){
  classes <- sapply(x, is.character)
  
  cols <- colnames(x)[classes]
  
  mutate_at(x, cols, tolower)
}

```

### Make 1 / 0 columns into T / F

```{r}
makeTF <- function(x){
  lengths <- summarize_all(x, function(x){length(unique(x)) <= 3})
  
  classes <- summarize_all(x, is.numeric)
  
  has10fn <- function(x){
    x[!is.na(x)] %>% 
      unique() %in% 
      c(0, 1) %>% 
      all()}
  
  has10 <- summarize_all(x, has10fn)
  
  conditions <- rbind(lengths, classes, has10) %>% 
    sapply(all)
  
  cols <- colnames(x)[conditions]

  trans_10_TF <- function(x){
    x <- gsub(pattern = "0", replacement = FALSE, x) %>%
      gsub(pattern = "1", replacement = TRUE)
    return(x)
  }

  mutate_at(x, cols, trans_10_TF)
}
```


### Function to remove blank (empty) characters

```{r}
remove_blanks <- function(x){
  classes <- sapply(x, is.character)
  
  cols <- colnames(x)[classes]
  
  mutate_at(x, cols, function(y){gsub(pattern = "^$", replacement = NA, y)})
}
```


### Remove characters with double blanks

```{r}
remove_double_blanks <- function(x){
  classes <- sapply(x, is.character)
  
  cols <- colnames(x)[classes]
  
  mutate_at(x, cols, function(y){gsub(pattern = "( )\\1+", replacement = "\\1", y)})
}
```


### Remove trailing and leading whitespaces

```{r}
remove_spaces <- function(x){
  classes <- sapply(x, is.character)
  
  cols <- colnames(x)[classes]
  
  mutate_at(x, cols, function(y){gsub(pattern = "^\\s+", replacement = "", y)})
}
```


### Remove "blank / blank"
```{r}
remove_bpunctb <- function(x){
  classes <- sapply(x, is.character)
  
  cols <- colnames(x)[classes]
  
  mutate_at(x, cols, function(y){gsub(pattern = "( / )", replacement = "/", y)})
  }
```

We can now use the functions above for general fixes, and use `mutate` to fix particular things

## Last inspection

```{r}

cooperatives <- ToLower(cooperatives_db) %>% # set to lower case
  makeTF() %>% 
  remove_blanks() %>% #remove blank (empty) cells)
  mutate(umbrella_organization = gsub(pattern = 0, replacement = FALSE, x = umbrella_organization), # Make 0's into FALSE
         umbrella_organization = gsub(pattern = "[1,2]", replacement = TRUE, x = umbrella_organization), # Make xi >= 1 into TRUE
         target_species = gsub(pattern = "[[:punct:]]", replacement = "", x = gsub("\\<callo de hacha\\>", "", target_species)), # Replace duplicated callo
         complete_name = gsub(pattern = "[[:punct:]]", replacement = "", x = gsub(pattern = "sp.", replacement = "spp", complete_name)),
         complete_name = ifelse(complete_name == "panuliris  argus", "panulirus argus", complete_name),
         complete_name = taxize::taxize_capwords(complete_name, strict = T, onlyfirst = T),
         species_growth = ifelse(species_growth == "slow", "low", species_growth),
         adult_movement = gsub(pattern = "--", replacement = "-", adult_movement),
         catch_share_types = gsub(pattern = "-", replacement = "", catch_share_types),
         catch_share_types = gsub(pattern = "coops", replacement = "coop", catch_share_types),
         gear_type = gsub(pattern = "artisianal", replacement = "artisanal", gear_type),
         use_of_catch = ifelse(use_of_catch == "1.local market (mostly wholesale) 2. subsistence (www.indiana.edu/~voconf/papers/thomson_voconf.pdf)", "local market/subsistance", use_of_catch),
         use_of_catch = gsub(pattern = ";", replacement = "/", use_of_catch)) %>%
  remove_double_blanks() %>%
  remove_spaces() %>%
  remove_bpunctb()

lapply(cooperatives, sort_unique) %>% 
  listviewer::jsonedit()
```


Everything looks good for now. We can go ahead and save this new version

```{r}
write.csv(x = cooperatives, file = "cooperatives_clean.csv", row.names = F)
save(cooperatives, file = "data/cooperatives.rda")
```













